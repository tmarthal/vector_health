
@main("Pollution Propagation") {
      <!-- Main hero unit for a primary marketing message or call to action -->
      <div class="hero-unit" style="padding:0px;">
        <p>
        	@map()
        </p>
      </div>

      <!-- Example row of columns -->
      <div class="row">
        <div class="span4">
          <h2>Pollution Sources</h2>
           <p>List of pollution sources</p>
           <input type="checkbox" id="airportcheck"> Show Airports<br/>
           <input type="checkbox" id="refinerycheck"> Show Refineries<br/>
           <br/>

           <input type="checkbox" id="pollutioncheck"> Show Pollution Radii<br/>
           
        </div>
        <div class="span4">
          <h2>Vulenerable Points</h2>
           <p>This we care about</p>
           <input type="checkbox" id="schoolcheck"> Show Schools<br/>
       </div>
        <div class="span4">
          <h2>Propagation Model</h2>
          <input type="checkbox" id="windcheck"> Show Wind Data <br/>
          Date:<br/>
          <input type="text" id="datetime" style="border: 0; color: #aaaaa; font-weight: bold;" /><br/>
		  <div id="timeslider" style="background:grey; width:180px;"></div><br/>
		  <i>Note: The grid data returned by the <a href="http://graphical.weather.gov/xml/#XML_contents">NDFD</a> needs to be explored further.</i>
        </div>
      </div>
    }
    
<script>
// initialize the time slider, for wind propagation
$(function() {
	// Represents the milliseconds from epoch, in 3 hour intervals
    $( "#timeslider" ).slider({
      value: 1369958400000,
      min: 1369958400000,
      max: 1370131200000,
      step: 10800000,
      slide: function( event, ui ) {
        $( "#datetime" ).val( moment(ui.value).format("YYYY/MM/DD+HH:mm Z") );
        displayWind(ui.value);
      }
    });
    // Global state of the slider
    sliderTime = $("#timeslider").slider("value");
    $( "#datetime" ).val( moment($("#timeslider").slider("value")).format("YYYY/MM/DD+HH:mm Z") );
    $("#windcheck").change(function() {
    	displayWind($("#timeslider").slider("value"));
   	});
    
    $("#airportcheck").change(function() {
     	var show = $(this).is(":checked"); 
     	console.log(show);
     	console.log(typeof show);
     	for (var i=0;i<airportMarkers.length;i++) {
     		airportMarkers[i].setVisible(show);
     	}
   	});
   	
    $("#refinerycheck").change(function() {
     	var show = $(this).is(":checked"); 
     	for (var i=0;i<refineryMarkers.length;i++) {
     		refineryMarkers[i].setVisible(show);
     	}
   	});

    $("#pollutioncheck").change(function() {
     	var show = $(this).is(":checked"); 
     	for (var i=0;i<pollutionMarkers.length;i++) {
     		pollutionMarkers[i].setVisible(show);
     	}
   	});
   	
    $("#schoolcheck").change(function() {
     	var show = $(this).is(":checked"); 
     	for (var i=0;i<schoolMarkers.length;i++) {
     		schoolMarkers[i].setVisible(show);
     	}
   	});
   	
   	// loading the time data json files
   	loadTimeData("@routes.Assets.at("data/wind/")");
});

// Calculates the pixel weight of the pollution
function scalePollution(pollution) {
	var logPollution = 2*Math.log(pollution);
	if (logPollution > 40) logPolltion = 40; 
	return logPollution;
}


// Initialize the pollution data
function loadSourceJSON() {
	console.log("loading?");

	// The array of scaled pollution circles 
	pollutionMarkers = []
	
	airportMarkers = []
	d3.json("@routes.Assets.at("data/pollute/airports.json")", function(data) {
		console.log("loading airport data");
		for (k in data) {
			var marker = new google.maps.Marker({
		  			position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
		  			map:map,
		  			icon: airportIcon,
		  			title: k,
		  			visible: false,
		  			content: '<div name="title">' + k +'</div><br/>' + '<div name="description">' + data[k].desc +'</div>'
			});			  
			airportMarkers.push(marker);
			
			var pollutionMarker = new google.maps.Marker({
  				position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
  				map: map,
  				icon: {
    				path: google.maps.SymbolPath.CIRCLE,
    				fillOpacity: 0.5,
    				fillColor: 'F88017',
    				strokeOpacity: 1.0,
    				strokeColor: 'fff000',
    				strokeWeight: 3.0, 
    				scale: scalePollution(data[k].pollution) //pixels
  				},
	  			visible: false,
			});
			pollutionMarkers.push(pollutionMarker);			
		}
		console.log("done airport data");
	});
	
	refineryMarkers = []
	d3.json("@routes.Assets.at("data/pollute/refinery.json")", function(data) {
		console.log("loading refinery data");
		for (k in data) {
			var marker = new google.maps.Marker({
		  			position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
		  			map:map,
		  			icon: airportIcon,
		  			title: k,
		  			visible: false,
		  			content: '<div name="title">' + k +'</div><br/>' + '<div name="description">' + data[k].desc +'</div>'
			});			  
			refineryMarkers.push(marker);

			var pollutionMarker = new google.maps.Marker({
  				position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
  				map: map,
  				icon: {
    				path: google.maps.SymbolPath.CIRCLE,
    				fillOpacity: 0.5,
    				fillColor: '222222',
    				strokeOpacity: 1.0,
    				strokeColor: 'aaaaaa',
    				strokeWeight: 3.0, 
    				scale: scalePollution(data[k].pollution) //pixels
  				},
	  			visible: false,
			});
			pollutionMarkers.push(pollutionMarker);			
		}
		console.log("done refinery data");
	});
	
}

// The source information
// Note: the d3.json calls should be ajax requests :(
function loadTargetJSON() {
	console.log("loading?");

	schoolMarkers = []
	d3.json("@routes.Assets.at("data/affected/schools.json")", function(data) {
		console.log("loading school data");
		for (k in data) {
			var schoolMarker = new google.maps.Marker({
		  			position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
		  			map:map,
		  			icon: schoolIcon,
		  			title: k,
		  			visible: false,
		  			content: '<div name="title">' + k +'</div><br/>' + '<div name="description">' + data[k].desc +'</div>'
			});			  
			schoolMarkers.push(schoolMarker);
		}
		console.log("done loading school data");
		//schoolMarkerCluster = new MarkerClusterer(map, schoolMarkers);
	});
	
	parkMarkers = [];
	d3.json("@routes.Assets.at("data/affected/parks.json")", function(data) {
		console.log("loading park data");
		for (k in data) {
			var marker = new google.maps.Marker({
		  			position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
		  			map:map,
		  			icon: parkIcon,
		  			title: k,
		  			visible: false,
		  			content: '<div name="title">' + k +'</div><br/>' + '<div name="description">' + data[k].desc +'</div>'
			});			  
			parkMarkers.push(marker);
		}
		console.log("done loading park data");
	});
	
	hospitalMarkers = [];
	d3.json("@routes.Assets.at("data/affected/hospitals.json")", function(data) {
		console.log("loading hospital data");
		for (k in data) {
			var marker = new google.maps.Marker({
		  			position: new google.maps.LatLng(data[k].coord[0], data[k].coord[1]),
		  			map:map,
		  			icon: hospitalIcon,
		  			title: k,
		  			visible: false,
		  			content: '<div name="title">' + k +'</div><br/>' + '<div name="description">' + data[k].desc +'</div>'
			});			  
			hospitalMarkers.push(marker);
		}
		console.log("done hospital park data");
	});
}



lineSymbol = {
    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
    scale: 1.5 //pixels
};


function displayWind(timestamp) {
	//
	var previousMarkerArrayName = 'lines'+sliderTime;
	var previousMarkers = window[previousMarkerArrayName];
	if (previousMarkers) {
   		for (var i=0;i<previousMarkers.length;i++) {
     		previousMarkers[i].setVisible(false);
		}
	}
	sliderTime = timestamp;

	// Check to see if we should draw, else return
	if (!$("#windcheck").is(":checked")) { return; }
	
	console.log("displaying wind for " + timestamp);
	var markerArrayName = 'lines'+timestamp;
	// Get the associated array from the window scope
	var localMarkers = window[markerArrayName];
	// if localMarkers is not defined, we slid to a time that does not have data
	if (localMarkers) {
   		for (var i=0;i<localMarkers.length;i++) {
     		localMarkers[i].setVisible(true);
		}
	} else {
		console.log("did not find data for time: " + timestamp);
	}
}

// Assume theta is in radians
function rotate2D(x, y, theta) {
  var xTemp = x;
  x = x*Math.cos(theta) - y*Math.sin(theta);
  y = xTemp*Math.sin(theta) + y*Math.cos(theta);
  return [x,y];
}


</script>

